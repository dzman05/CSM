<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© - ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø­Ø© ÙˆØ§Ù„ØµÙ†Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #1e3a8a;
            /* Dark Blue */
            --secondary: #d97706;
            /* Gold/Amber */
            --bg: #f8fafc;
            --text: #1e293b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* --- Login Overlay --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            width: 400px;
            text-align: center;
        }

        .login-logos {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .login-logos img {
            height: 80px;
            object-fit: contain;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .login-subtitle {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn-login {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-login:hover {
            background-color: #1e40af;
        }

        /* --- Dashboard --- */
        #dashboard-container {
            display: none;
            height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
        }

        /* Header */
        header {
            background: var(--white);
            border-bottom: 1px solid #e2e8f0;
            padding: 0 2rem;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .brand img {
            height: 60px;
        }

        .brand-text h1 {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .brand-text p {
            font-size: 0.8rem;
            color: #64748b;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            w: 40px;
            height: 40px;
            background: #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary);
        }

        /* Main Content */
        main {
            padding: 2rem;
            overflow-y: auto;
            background-color: #f1f5f9;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background-color: var(--secondary);
        }

        .stat-title {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-icon {
            position: absolute;
            left: 20px;
            bottom: 20px;
            font-size: 3rem;
            opacity: 0.1;
        }

        /* Charts Section */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 500px;
        }

        .chart-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .chart-title {
            font-weight: 700;
            color: var(--primary);
        }

        /* Map Placeholder */
        .map-placeholder {
            width: 100%;
            height: 90%;
            background: #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Dz_-_Algeria.svg/1200px-Dz_-_Algeria.svg.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Table */
        .table-container {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: right;
            padding: 15px;
            border-bottom: 2px solid #e2e8f0;
            color: #64748b;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
        }

        .bg-green {
            background: #dcfce7;
            color: #166534;
        }

        .bg-orange {
            background: #fff7ed;
            color: #ea580c;
        }

        .bg-blue {
            background: #eff6ff;
            color: #2563eb;
        }

        .bg-red {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modal SlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--primary);
        }

        .modal-body {
            text-align: right;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #64748b;
            font-weight: 600;
        }

        .stat-value-modal {
            color: var(--primary);
            font-weight: 800;
        }

        .wilaya-name-clickable {
            cursor: pointer;
            color: var(--primary);
            text-decoration: underline;
            transition: color 0.2s;
        }

        .wilaya-name-clickable:hover {
            color: var(--secondary);
        }

        .edu-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #e2e8f0;
            color: #475569;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* --- Responsive Design (Mobile) --- */
        @media (max-width: 768px) {

            /* Login Card */
            .login-card {
                width: 90%;
                padding: 2rem;
            }

            /* Header */
            header {
                flex-direction: column;
                height: auto;
                padding: 1rem;
                gap: 1rem;
                text-align: center;
            }

            .brand {
                flex-direction: column;
            }

            .user-profile {
                width: 100%;
                justify-content: center;
                border-top: 1px solid #f1f5f9;
                padding-top: 10px;
            }

            /* Stats Grid */
            .stats-grid {
                grid-template-columns: 1fr;
                /* Stack vertically */
                gap: 15px;
            }

            /* Charts Row */
            .charts-row {
                grid-template-columns: 1fr;
                height: auto;
            }

            .chart-card {
                height: 400px;
                /* Fixed height for stacked charts */
            }

            /* Table */
            .table-container {
                overflow-x: auto;
                /* Scrollable horizontal */
            }

            table {
                min-width: 600px;
                /* Force scroll if too narrow */
            }

            th,
            td {
                padding: 10px;
                font-size: 0.9rem;
            }

            /* Modal */
            .modal-content {
                width: 95%;
                margin: 0 10px;
                padding: 20px;
            }

            /* General text adjustments */
            .brand-text h1 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>

    <!-- Login -->
    <div id="login-overlay">
        <div class="login-card">
            <div class="login-logos">
                <img src="https://cdn-icons-png.flaticon.com/512/263/263086.png" alt="Ministry Logo"
                    style="filter: grayscale(100%); opacity: 0.7"> <!-- Generic Emblem -->
                <img src="assets/img/center_logo.png" alt="Chamber Logo">
            </div>
            <div class="login-title">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©</div>
            <div class="login-subtitle">ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø­Ø© ÙˆØ§Ù„ØµÙ†Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© - Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ©</div>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="btn-login">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
            </form>
        </div>
        <p style="color: #94a3b8; margin-top: 20px; font-size: 0.8rem;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ø§Ù Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© v1.0 &copy; 2026</p>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-container" style="display: none;">
        <header>
            <div class="brand">
                <img src="assets/img/center_logo.png" alt="Logo">
                <div class="brand-text">
                    <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</h1>
                    <p>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¢Ù†ÙŠØ© Ù„ØºØ±Ù Ø§Ù„ØµÙ†Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© ÙˆØ§Ù„Ø­Ø±Ù</p>
                </div>
            </div>
            <div class="user-profile">
                <span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„ÙˆØ²ÙŠØ±</span>
                <div class="avatar">Ù…</div>
            </div>
        </header>

        <main>
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon bg-orange">ğŸ‘¥</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ±Ø¨ØµÙŠÙ†</div>
                    </div>
                    <div class="stat-value" id="total-students">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">ğŸ›ï¸</div>
                        <div class="stat-label">Ø§Ù„ØºØ±Ù Ø§Ù„Ù†Ø´Ø·Ø©</div>
                    </div>
                    <div class="stat-value" id="active-centers">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon bg-red">ğŸ“</div>
                        <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
                    </div>
                    <div class="stat-value" id="total-requests">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon bg-blue">ğŸ¤</div>
                        <div class="stat-label">Ø§Ù„Ù…ÙƒÙˆÙ†ÙŠÙ† ÙˆØ§Ù„Ø§ØªÙØ§Ù‚ÙŠØ§Øª</div>
                    </div>
                    <div class="stat-value" id="total-resources">0 / 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</div>
                    <div class="stat-value" id="total-courses">0</div>
                    <div class="stat-icon">ğŸ“š</div>
                </div>
            </div>

            <!-- Charts & Map -->
            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <span class="chart-title">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ù†Ø´Ø§Ø·</span>
                    </div>
                    <div class="map-placeholder" id="algeria-map"
                        style="position: relative; overflow: hidden; width: 100%; height: 90%;">
                        <!-- OpenStreetMap will be rendered here by Leaflet.js -->
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <span class="chart-title">Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø£Ø¯Ø§Ø¡Ù‹</span>
                    </div>
                    <canvas id="topWilayasChart"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="chart-header">
                    <span class="chart-title">Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª (58 ÙˆÙ„Ø§ÙŠØ©)</span>
                    <button
                        style="padding: 5px 15px; background: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer;">ØªØµØ¯ÙŠØ±
                        Excel</button>
                    <button onclick="location.reload()"
                        style="padding: 5px 15px; background: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø±Ù…Ø²</th>
                            <th>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</th>
                            <th>Ø§Ù„Ù…ØªØ±Ø¨ØµÙŠÙ†</th>
                            <th>Ø§Ù„Ø¯ÙˆØ±Ø§Øª</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body">
                        <!-- JS fill -->
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <footer
                style="background: var(--white); padding: 15px 20px; margin-top: 30px; border-radius: 12px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: right; color: #64748b; font-size: 0.85rem;">
                    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2026
                </div>
                <div style="text-align: left; color: #64748b; font-size: 0.85rem;">
                    Ø¨Ø±Ù…Ø¬Ø©: <strong style="color: var(--primary);">Ø¹ÙŠØ´ÙŠ ÙŠØ³ÙŠÙ†</strong> | ğŸ“ 0660639890
                </div>
            </footer>
        </main>
    </div>

    <!-- Wilaya Details Modal -->
    <div id="wilaya-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-wilaya-name"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-wilaya-body">
                <!-- Content will be filled by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Dynamic Stats Loader (Cache Busting) -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var script = document.createElement('script');
            // Add timestamp to force reload
            script.src = 'data/stats.js?v=' + new Date().getTime();

            script.onload = function () {
                console.log("Stats loaded");
                initDashboard();
            };

            script.onerror = function () {
                console.error("Failed to load stats.js");
                // Fallback
                if (typeof NATIONAL_STATS === 'undefined') {
                    window.NATIONAL_STATS = [];
                }
                initDashboard();
            };

            document.head.appendChild(script);
        });
    </script>

    <!-- Removed static stats.js script -->

    <script>
        // Master List of 58 Wilayas
        const ALL_WILAYAS = [
            { code: "01", name: "Ø£Ø¯Ø±Ø§Ø±" }, { code: "02", name: "Ø§Ù„Ø´Ù„Ù" }, { code: "03", name: "Ø§Ù„Ø£ØºÙˆØ§Ø·" }, { code: "04", name: "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ" }, { code: "05", name: "Ø¨Ø§ØªÙ†Ø©" },
            { code: "06", name: "Ø¨Ø¬Ø§ÙŠØ©" }, { code: "07", name: "Ø¨Ø³ÙƒØ±Ø©" }, { code: "08", name: "Ø¨Ø´Ø§Ø±" }, { code: "09", name: "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©" }, { code: "10", name: "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©" },
            { code: "11", name: "ØªÙ…Ù†Ø±Ø§Ø³Øª" }, { code: "12", name: "ØªØ¨Ø³Ø©" }, { code: "13", name: "ØªÙ„Ù…Ø³Ø§Ù†" }, { code: "14", name: "ØªÙŠØ§Ø±Øª" }, { code: "15", name: "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ" },
            { code: "16", name: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±" }, { code: "17", name: "Ø§Ù„Ø¬Ù„ÙØ©" }, { code: "18", name: "Ø¬ÙŠØ¬Ù„" }, { code: "19", name: "Ø³Ø·ÙŠÙ" }, { code: "20", name: "Ø³Ø¹ÙŠØ¯Ø©" },
            { code: "21", name: "Ø³ÙƒÙŠÙƒØ¯Ø©" }, { code: "22", name: "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³" }, { code: "23", name: "Ø¹Ù†Ø§Ø¨Ø©" }, { code: "24", name: "Ù‚Ø§Ù„Ù…Ø©" }, { code: "25", name: "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©" },
            { code: "26", name: "Ø§Ù„Ù…Ø¯ÙŠØ©" }, { code: "27", name: "Ù…Ø³ØªØºØ§Ù†Ù…" }, { code: "28", name: "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©" }, { code: "29", name: "Ù…Ø¹Ø³ÙƒØ±" }, { code: "30", name: "ÙˆØ±Ù‚Ù„Ø©" },
            { code: "31", name: "ÙˆÙ‡Ø±Ø§Ù†" }, { code: "32", name: "Ø§Ù„Ø¨ÙŠØ¶" }, { code: "33", name: "Ø¥Ù„ÙŠØ²ÙŠ" }, { code: "34", name: "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬" }, { code: "35", name: "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³" },
            { code: "36", name: "Ø§Ù„Ø·Ø§Ø±Ù" }, { code: "37", name: "ØªÙ†Ø¯ÙˆÙ" }, { code: "38", name: "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª" }, { code: "39", name: "Ø§Ù„ÙˆØ§Ø¯ÙŠ" }, { code: "40", name: "Ø®Ù†Ø´Ù„Ø©" },
            { code: "41", name: "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³" }, { code: "42", name: "ØªÙŠØ¨Ø§Ø²Ø©" }, { code: "43", name: "Ù…ÙŠÙ„Ø©" }, { code: "44", name: "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰" }, { code: "45", name: "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©" },
            { code: "46", name: "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª" }, { code: "47", name: "ØºØ±Ø¯Ø§ÙŠØ©" }, { code: "48", name: "ØºÙ„ÙŠØ²Ø§Ù†" }, { code: "49", name: "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†" }, { code: "50", name: "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±" },
            { code: "51", name: "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„" }, { code: "52", name: "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³" }, { code: "53", name: "Ø¹ÙŠÙ† ØµØ§Ù„Ø­" }, { code: "54", name: "Ø¹ÙŠÙ† Ù‚Ø²Ø§Ù…" }, { code: "55", name: "ØªÙ‚Ø±Øª" },
            { code: "56", name: "Ø¬Ø§Ù†Øª" }, { code: "57", name: "Ø§Ù„Ù…ØºÙŠØ±" }, { code: "58", name: "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©" }
        ];

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            // Simulation
            if (u && p) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard-container').style.display = 'grid'; // Fix layout
                // initDashboard() will be called by script loader or if already loaded
                if (typeof NATIONAL_STATS !== 'undefined') {
                    initDashboard();
                }
            }
        }


        function initDashboard() {
            // Check if stats variable exists from data/stats.js
            let statsMap = {};
            if (typeof NATIONAL_STATS !== 'undefined') {
                NATIONAL_STATS.forEach(item => {
                    statsMap[item.code] = item;
                });
            }

            let totalStud = 0;
            let totalCourses = 0;
            let totalRequests = 0;
            let totalTeachers = 0;
            let totalAgreements = 0;
            let activeCenters = 0;

            const tbody = document.getElementById('stats-table-body');
            tbody.innerHTML = '';

            // Iterate ALL Wilayas
            ALL_WILAYAS.forEach(wilaya => {
                const data = statsMap[wilaya.code];
                let rowHTML = '';

                if (data) {
                    // Data Exists
                    totalStud += data.students;
                    totalCourses += data.courses;
                    totalRequests += (data.requests_total || 0);
                    totalTeachers += (data.teachers_count || 0);
                    totalAgreements += (data.agreements_count || 0);
                    activeCenters++;

                    rowHTML = `
                        <tr>
                            <td>${wilaya.code}</td>
                            <td><span class="wilaya-name-clickable" onclick="showWilayaDetails('${wilaya.code}')">${wilaya.name}</span></td>
                            <td>${data.students}</td>
                            <td>${data.courses}</td>
                            <td><span class="status-badge bg-green">Ù…Ø­Ø¯Ø«</span></td>
                        </tr>
                    `;
                } else {
                    // Start Update: Handle Missing Data
                    rowHTML = `
                        <tr style="background-color: #f8fafc; color: #94a3b8;">
                            <td>${wilaya.code}</td>
                            <td><span class="wilaya-name-clickable" onclick="showWilayaDetails('${wilaya.code}')">${wilaya.name}</span></td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td><span class="status-badge bg-red">Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ù…Ø«Ø¨Øª</span></td>
                        </tr>
                    `;
                    // End Update
                }
                tbody.innerHTML += rowHTML;
            });

            // Update Top Cards
            document.getElementById('total-students').innerText = totalStud.toLocaleString();
            document.getElementById('total-requests').innerText = totalRequests.toLocaleString();
            document.getElementById('total-resources').innerText = `${totalTeachers} / ${totalAgreements}`;
            document.getElementById('active-centers').innerText = activeCenters;

            // Simple Chart (Only for Active Data)
            const ctx = document.getElementById('topWilayasChart').getContext('2d');

            const activeData = (typeof NATIONAL_STATS !== 'undefined') ? [...NATIONAL_STATS] : [];
            activeData.sort((a, b) => b.students - a.students); // Sort by students

            const top5 = activeData.slice(0, 5);

            if (top5.length > 0) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top5.map(d => d.name),
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ±Ø¨ØµÙŠÙ†',
                            data: top5.map(d => d.students),
                            backgroundColor: '#0078D4',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }


            // Render Interactive Map
            renderMap(statsMap);
        }

        function showWilayaDetails(code) {
            const wilaya = ALL_WILAYAS.find(w => w.code === code);
            let statsMap = {};
            if (typeof NATIONAL_STATS !== 'undefined') {
                NATIONAL_STATS.forEach(item => {
                    statsMap[item.code] = item;
                });
            }

            const data = statsMap[code];
            const modal = document.getElementById('wilaya-modal');
            const title = document.getElementById('modal-wilaya-name');
            const body = document.getElementById('modal-wilaya-body');

            title.innerText = `ØªÙØ§ØµÙŠÙ„ ÙˆÙ„Ø§ÙŠØ© ${wilaya.name} (${code})`;

            let bodyHTML = '';
            if (data) {
                // Education levels tags
                let eduHtml = '';
                if (data.students_edu_levels) {
                    Object.entries(data.students_edu_levels).forEach(([lvl, count]) => {
                        eduHtml += `<span class="edu-badge">${lvl}: ${count}</span>`;
                    });
                }

                bodyHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="stat-group">
                            <h3 style="font-size: 0.9rem; border-bottom: 1px solid #eee; margin-bottom: 10px; color: var(--secondary);">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªØ±Ø¨ØµÙŠÙ†</h3>
                            <div class="stat-row"><span class="stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="stat-value-modal">${data.students}</span></div>
                            <div class="stat-row"><span class="stat-label">Ø°ÙƒØ±</span><span class="stat-value-modal">${data.students_male || 0}</span></div>
                            <div class="stat-row"><span class="stat-label">Ø£Ù†Ø«Ù‰</span><span class="stat-value-modal">${data.students_female || 0}</span></div>
                        </div>
                        <div class="stat-group">
                            <h3 style="font-size: 0.9rem; border-bottom: 1px solid #eee; margin-bottom: 10px; color: var(--secondary);">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
                            <div class="stat-row"><span class="stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="stat-value-modal">${data.requests_total || 0}</span></div>
                            <div class="stat-row"><span class="stat-label">Ø°ÙƒØ±</span><span class="stat-value-modal">${data.requests_male || 0}</span></div>
                            <div class="stat-row"><span class="stat-label">Ø£Ù†Ø«Ù‰</span><span class="stat-value-modal">${data.requests_female || 0}</span></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <h3 style="font-size: 0.9rem; border-bottom: 1px solid #eee; margin-bottom: 10px; color: var(--secondary);">Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù†Ø´Ø§Ø·</h3>
                        <div class="stat-row"><span class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒÙˆÙ†ÙŠÙ† Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠÙŠÙ†/Ø§Ù„Ø­Ø±ÙÙŠÙŠÙ†</span><span class="stat-value-modal">${data.teachers_count || 0}</span></div>
                        <div class="stat-row"><span class="stat-label">Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†</span><span class="stat-value-modal">${data.agreements_count || 0}</span></div>
                        <div class="stat-row"><span class="stat-label">Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹</span><span class="stat-value-modal" style="color: #059669;">${data.most_active_course || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></div>
                    </div>

                    <div style="margin-top: 15px;">
                        <h3 style="font-size: 0.9rem; border-bottom: 1px solid #eee; margin-bottom: 10px; color: var(--secondary);">Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h3>
                        <div style="display: flex; flex-wrap: wrap; margin-top: 5px;">
                            ${eduHtml || '<span style="color: #94a3b8; font-size: 0.8rem;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span>'}
                        </div>
                    </div>

                    <div class="stat-row" style="margin-top: 15px; border-top: 2px solid #eee; padding-top: 10px;">
                        <span class="stat-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</span>
                        <span class="stat-value-modal" style="font-size: 0.8rem; color: #64748b;">${data.last_updated}</span>
                    </div>
                `;
            } else {
                bodyHTML = `
                    <div style="text-align: center; padding: 20px; color: #94a3b8;">
                        <span style="font-size: 3rem; display: block; margin-bottom: 10px;">âš ï¸</span>
                        <p>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ù…Ø«Ø¨Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                        <p style="font-size: 0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ²Ø§Ù…Ù†Ø© Ù„Ù„Ø¹Ø±Ø¶.</p>
                    </div>
                `;
            }

            body.innerHTML = bodyHTML;
            modal.style.display = 'flex';
        }

        function closeModal(e) {
            document.getElementById('wilaya-modal').style.display = 'none';
        }

        function renderMap(statsMap) {
            const mapContainer = document.getElementById('algeria-map');
            if (!mapContainer) return;

            // Clear any existing content
            mapContainer.innerHTML = '';

            // Initialize Leaflet map centered on Algeria
            const map = L.map('algeria-map', {
                center: [28.0, 3.0], // Center of Algeria
                zoom: 5,
                minZoom: 5,
                maxZoom: 10,
                zoomControl: true
            });

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Approximate real geographic coordinates for each wilaya (capital city)
            const wilayaCoords = {
                "01": [27.9, -0.2], "02": [36.17, 1.33], "03": [33.8, 2.9], "04": [35.85, 7.1], "05": [35.56, 6.17],
                "06": [36.75, 5.08], "07": [34.85, 5.73], "08": [31.6, -2.23], "09": [36.47, 2.83], "10": [36.37, 3.9],
                "11": [22.78, 5.52], "12": [35.4, 8.12], "13": [34.88, -1.32], "14": [35.37, 1.47], "15": [36.72, 4.05],
                "16": [36.75, 3.04], "17": [34.67, 3.25], "18": [36.82, 5.77], "19": [36.19, 5.41], "20": [34.84, 0.15],
                "21": [36.88, 6.91], "22": [35.19, -0.63], "23": [36.9, 7.76], "24": [36.46, 8.15], "25": [36.36, 6.61],
                "26": [36.27, 2.75], "27": [35.93, 0.09], "28": [35.7, 4.54], "29": [35.4, 0.14], "30": [31.95, 5.33],
                "31": [35.7, -0.64], "32": [33.68, 1.17], "33": [26.5, 8.48], "34": [36.07, 4.77], "35": [36.76, 3.48],
                "36": [36.76, 8.31], "37": [27.67, -8.14], "38": [35.6, 1.81], "39": [33.37, 6.87], "40": [35.44, 7.14],
                "41": [36.29, 8.41], "42": [36.47, 2.42], "43": [36.45, 6.26], "44": [36.26, 1.86], "45": [33.27, -0.31],
                "46": [35.3, -1.14], "47": [32.48, 3.67], "48": [36.17, 1.37], "49": [29.25, 0.23], "50": [26.32, -1.15],
                "51": [34.42, 4.93], "52": [30.13, -2.17], "53": [27.22, 0.59], "54": [28.05, 9.64], "55": [33.13, 6.06],
                "56": [24.55, 9.49], "57": [34.07, 5.63], "58": [30.58, 2.87]
            };

            // Add markers for each wilaya
            ALL_WILAYAS.forEach(wilaya => {
                const coords = wilayaCoords[wilaya.code];
                if (!coords) return;

                const hasData = statsMap[wilaya.code];

                // Create custom icon
                const iconHtml = `
                    <div style="
                        width: ${hasData ? '18px' : '12px'}; 
                        height: ${hasData ? '18px' : '12px'}; 
                        background-color: ${hasData ? '#10b981' : '#cbd5e1'};
                        border: 2px solid ${hasData ? '#059669' : '#94a3b8'};
                        border-radius: 50%;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    "></div>
                `;

                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-marker',
                    iconSize: [hasData ? 18 : 12, hasData ? 18 : 12],
                    iconAnchor: [hasData ? 9 : 6, hasData ? 9 : 6]
                });

                // Create marker
                const marker = L.marker(coords, { icon: customIcon }).addTo(map);

                // Create popup content
                let popupContent = `<div dir="rtl" style="text-align: right; font-family: 'Cairo', sans-serif;">
                    <strong style="font-size: 14px;">${wilaya.name} (${wilaya.code})</strong><br>`;

                if (hasData) {
                    popupContent += `
                        <span style="color: #059669;">âœ“ Ù…Ø­Ø¯Ø«</span><br>
                        Ø§Ù„Ù…ØªØ±Ø¨ØµÙŠÙ†: <strong>${statsMap[wilaya.code].students}</strong><br>
                        Ø§Ù„Ù…Ø¯Ø§Ø®ÙŠÙ„: <strong>${statsMap[wilaya.code].revenue.toLocaleString()} Ø¯Ø¬</strong><br>
                        Ø§Ù„Ø¯ÙˆØ±Ø§Øª: <strong>${statsMap[wilaya.code].courses}</strong>
                    `;
                } else {
                    popupContent += `<span style="color: #991b1b;">âœ— Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ù…Ø«Ø¨Øª</span>`;
                }

                popupContent += `</div>`;
                marker.bindPopup(popupContent);

                // Show popup on hover for active wilayas
                if (hasData) {
                    marker.on('mouseover', function () {
                        this.openPopup();
                    });
                }
            });
        }
    </script>
</body>

</html>